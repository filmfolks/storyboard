<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mobile-Optimized Gutendex Ebook & LibriVox Player</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #fff;
    color: #000;
  }
  .dark-mode {
    background-color: #121212;
    color: #e0e0e0;
  }
  header {
    background-color: #0066cc;
    color: white;
    padding: 10px 15px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
  }
  header select, header button {
    padding: 5px 10px;
    font-size: 14px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
  }
  header select {
    min-width: 160px;
  }
  #results {
    padding: 15px;
    max-height: 300px;
    overflow-y: auto;
  }
  #results ul {
    list-style: none;
    padding: 0;
  }
  #results li {
    margin-bottom: 10px;
    cursor: pointer;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
  }
  #reader {
    padding: 15px;
  }
  .hidden {
    display: none;
  }
  #book-title {
    font-weight: bold;
    font-size: 20px;
    margin-bottom: 10px;
  }
  #book-content {
    white-space: pre-wrap;
    font-size: 16px;
    line-height: 1.5;
    max-height: 65vh;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  #controls {
    margin-top: 10px;
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    gap: 10px;
    overflow-x: auto;
  }
  #controls button, #controls select, #controls input[type='range'] {
    padding: 6px 10px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
    cursor: pointer;
    white-space: nowrap;
  }
  #controls input[type='range'] {
    flex-grow: 1;
    min-width: 50px;
  }
  #audioPlayer {
    width: 100%;
    margin-top: 10px;
    outline: none;
  }
  @media (max-width: 600px) {
    header {
      flex-direction: column;
      align-items: stretch;
    }
    header select {
      width: 100%;
      margin-bottom: 8px;
    }
    #results {
      max-height: 200px;
    }
    #book-content {
      font-size: 16px;
      max-height: 70vh;
    }
    #controls {
      flex-wrap: nowrap;
    }
  }
</style>
</head>
<body>
<header>
  <select id="genreSelect">
    <option value="">Select Genre</option>
  </select>
  <select id="authorSelect">
    <option value="">Select Author</option>
  </select>
  <select id="categorySelect">
    <option value="">Select Category</option>
  </select>
  <button id="filterButton">Filter Books</button>
  <button id="darkModeButton">Dark Mode</button>
  <button id="fullscreenButton">Fullscreen</button>
</header>
<div id="results"></div>
<div id="reader" class="hidden">
  <div id="book-title"></div>
  <div id="error-message" class="hidden" style="color:red;font-weight:bold"></div>
  <div id="book-content"></div>
  <div id="controls">
    <button id="fontIncrease">A+</button>
    <button id="fontDecrease">A-</button>
    <button id="ttsPlayPause">Play TTS</button>
    <button id="ttsStop">Stop TTS</button>
    <label for="voiceSelect">Voice:</label>
    <select id="voiceSelect" aria-label="Select voice for text to speech"></select>
    <label for="rateRange">Rate:</label>
    <input type="range" id="rateRange" min="0.5" max="2" value="1" step="0.1" aria-label="Speech rate control" />
    <label for="pitchRange">Pitch:</label>
    <input type="range" id="pitchRange" min="0" max="2" value="1" step="0.1" aria-label="Speech pitch control" />
    <button id="playAudiobook">Play Audiobook</button>
    <button id="backButton">Back to List</button>
  </div>
  <audio id="audioPlayer" controls class="hidden" aria-label="Audiobook player"></audio>
</div>
<script>
  const genreSelect = document.getElementById('genreSelect');
  const authorSelect = document.getElementById('authorSelect');
  const categorySelect = document.getElementById('categorySelect');
  const filterButton = document.getElementById('filterButton');
  const resultsDiv = document.getElementById('results');
  const readerDiv = document.getElementById('reader');
  const bookTitleDiv = document.getElementById('book-title');
  const bookContentDiv = document.getElementById('book-content');
  const errorMessageDiv = document.getElementById('error-message');
  const fontIncreaseBtn = document.getElementById('fontIncrease');
  const fontDecreaseBtn = document.getElementById('fontDecrease');
  const ttsPlayPauseBtn = document.getElementById('ttsPlayPause');
  const ttsStopBtn = document.getElementById('ttsStop');
  const voiceSelect = document.getElementById('voiceSelect');
  const rateRange = document.getElementById('rateRange');
  const pitchRange = document.getElementById('pitchRange');
  const darkModeButton = document.getElementById('darkModeButton');
  const fullscreenButton = document.getElementById('fullscreenButton');
  const backButton = document.getElementById('backButton');
  const playAudiobookBtn = document.getElementById('playAudiobook');
  const audioPlayer = document.getElementById('audioPlayer');

  let currentFontSize = 16;
  let speechSynthesisUtterance = null;
  let isDarkMode = false;
  let voices = [];
  let currentBookTitle = '';
  let currentBookAuthor = '';

  function populateSelect(select, options) {
    options.forEach(opt => {
      const optionEl = document.createElement('option');
      optionEl.value = opt.toLowerCase();
      optionEl.textContent = opt;
      select.appendChild(optionEl);
    });
  }

  const genres = ['Science Fiction', 'Romance', 'Fantasy', 'Adventure', 'Horror', 'Children', 'Mystery', 'Historical'];
  const categories = ['Children', 'Classics', 'Fiction', 'Nonfiction', 'Poetry', 'Drama', 'Horror', 'Science Fiction'];

  populateSelect(genreSelect, genres);
  populateSelect(categorySelect, categories);

  function isMobile() {
    return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
  }

  async function fetchAuthors() {
    try {
      const response = await fetch('https://gutendex.com/books?sort=popular');
      const data = await response.json();
      const authorsSet = new Set();
      data.results.forEach(book => {
        book.authors.forEach(author => {
          authorsSet.add(author.name);
        });
      });
      const authors = Array.from(authorsSet).sort();
      authors.forEach(author => {
        const optionEl = document.createElement('option');
        optionEl.value = author.toLowerCase();
        optionEl.textContent = author;
        authorSelect.appendChild(optionEl);
      });
    } catch (error) {
      console.error('Error fetching authors', error);
    }
  }
  fetchAuthors();

  async function filterBooks() {
    resultsDiv.innerHTML = '<p>Loading books...</p>';
    readerDiv.classList.add('hidden');
    audioPlayer.classList.add('hidden');
    audioPlayer.pause();
    try {
      const selectedGenre = genreSelect.value;
      const selectedAuthor = authorSelect.value;
      const selectedCategory = categorySelect.value;

      let combinedResults = [];
      const seenIds = new Set();

      async function addResults(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        const data = await res.json();
        data.results.forEach(book => {
          if (!seenIds.has(book.id)) {
            combinedResults.push(book);
            seenIds.add(book.id);
          }
        });
      }

      let queries = [];
      if (selectedGenre) {
        queries.push(`https://gutendex.com/books?topic=${selectedGenre}&sort=popular`);
      }
      if (selectedCategory && selectedCategory !== selectedGenre) {
        queries.push(`https://gutendex.com/books?topic=${selectedCategory}&sort=popular`);
      }
      if (selectedAuthor) {
        queries.push(`https://gutendex.com/books?search=${selectedAuthor}&sort=popular`);
      }
      if (queries.length === 0) {
        queries.push('https://gutendex.com/books?sort=popular');
      }

      await Promise.all(queries.map(q => addResults(q)));

      if (combinedResults.length === 0) {
        resultsDiv.innerHTML = '<p>No books found.</p>';
        return;
      }

      displayResults(combinedResults);
    } catch (error) {
      console.error('Filter error:', error);
      resultsDiv.innerHTML = '<p>Error retrieving books. Check console for details.</p>';
    }
  }

  function displayResults(books) {
    let html = '<ul>';
    books.forEach(book => {
      html += `<li data-id="${book.id}">${book.title} <br/><small>by ${book.authors.map(a => a.name).join(", ")}</small></li>`;
    });
    html += '</ul>';
    resultsDiv.innerHTML = html;

    document.querySelectorAll('#results li').forEach(li => {
      li.addEventListener('click', async () => {
        const bookId = li.getAttribute('data-id');
        await openBook(bookId);
      });
    });
  }

  async function openBook(bookId) {
    resultsDiv.innerHTML = '<p>Loading book content...</p>';
    errorMessageDiv.classList.add('hidden');
    bookContentDiv.textContent = '';
    audioPlayer.classList.add('hidden');
    audioPlayer.pause();
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    try {
      const response = await fetch(`https://gutendex.com/books/${bookId}`);
      if (!response.ok) throw new Error(`Metadata fetch failed: ${response.status}`);
      const book = await response.json();
      bookTitleDiv.textContent = book.title + ' by ' + book.authors.map(a => a.name).join(', ');
      currentBookTitle = book.title;
      currentBookAuthor = book.authors.map(a => a.name).join(', ');

      const possibleFormats = [
        'text/plain; charset=utf-8',
        'text/plain',
        'text/html; charset=utf-8',
        'text/html',
      ];

      let textData = '';
      for (const fmt of possibleFormats) {
        let textUrl = book.formats[fmt];
        if (textUrl) {
          const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(textUrl);
          const textResponse = await fetch(proxyUrl);
          if (!textResponse.ok) continue;
          textData = await textResponse.text();

          if (fmt.includes('html')) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(textData, 'text/html');
            textData = doc.body.textContent || doc.body.innerText || '';
          }

          if (textData) break;
        }
      }

      if (!textData) {
        throw new Error('No supported readable format found in Gutendex.');
      }

      bookContentDiv.textContent = textData.trim();
      currentFontSize = 16;
      bookContentDiv.style.fontSize = currentFontSize + 'px';
      readerDiv.classList.remove('hidden');
      resultsDiv.innerHTML = '';
    } catch (err) {
      console.error('Load error:', err);
      errorMessageDiv.textContent = `Error: ${err.message}`;
      errorMessageDiv.classList.remove('hidden');
      resultsDiv.innerHTML = '';
    }
  }

  ttsPlayPauseBtn.addEventListener('click', () => {
    audioPlayer.pause();
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      ttsPlayPauseBtn.textContent = 'Play TTS';
    } else {
      if (isMobile()) {
        // Use simplified TTS on mobile devices (native TTS with fewer controls)
        const text = bookContentDiv.textContent;
        if (text.length > 0) {
          speechSynthesisUtterance = new SpeechSynthesisUtterance(text);
          speechSynthesisUtterance.onend = () => {
            ttsPlayPauseBtn.textContent = 'Play TTS';
          };
          speechSynthesis.speak(speechSynthesisUtterance);
          ttsPlayPauseBtn.textContent = 'Pause TTS';
        }
      } else {
        // Desktop TTS with voice controls
        const text = bookContentDiv.textContent;
        if (text.length > 0) {
          speechSynthesisUtterance = new SpeechSynthesisUtterance(text);
          speechSynthesisUtterance.voice = voices[voiceSelect.selectedIndex] || null;
          speechSynthesisUtterance.rate = parseFloat(rateRange.value) || 1;
          speechSynthesisUtterance.pitch = parseFloat(pitchRange.value) || 1;
          speechSynthesisUtterance.onend = () => {
            ttsPlayPauseBtn.textContent = 'Play TTS';
          };
          speechSynthesis.speak(speechSynthesisUtterance);
          ttsPlayPauseBtn.textContent = 'Pause TTS';
        }
      }
    }
  });

  ttsStopBtn.addEventListener('click', () => {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    ttsPlayPauseBtn.textContent = 'Play TTS';
  });

  function loadVoices() {
    voices = speechSynthesis.getVoices();
    voiceSelect.innerHTML = '';
    voices.forEach(voice => {
      const option = document.createElement('option');
      option.textContent = `${voice.name} (${voice.lang})`;
      option.value = voice.name;
      voiceSelect.appendChild(option);
    });
  }
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  fontIncreaseBtn.addEventListener('click', () => {
    currentFontSize += 2;
    bookContentDiv.style.fontSize = currentFontSize + 'px';
  });

  fontDecreaseBtn.addEventListener('click', () => {
    if (currentFontSize > 10) {
      currentFontSize -= 2;
      bookContentDiv.style.fontSize = currentFontSize + 'px';
    }
  });

  darkModeButton.addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
      darkModeButton.textContent = 'Light Mode';
    } else {
      document.body.classList.remove('dark-mode');
      darkModeButton.textContent = 'Dark Mode';
    }
  });

  fullscreenButton.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });

  backButton.addEventListener('click', () => {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    audioPlayer.pause();
    audioPlayer.classList.add('hidden');
    readerDiv.classList.add('hidden');
    resultsDiv.innerHTML = '';
    errorMessageDiv.classList.add('hidden');
  });

  playAudiobookBtn.addEventListener('click', async () => {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    audioPlayer.classList.add('hidden');
    audioPlayer.pause();
    try {
      const lvUrl = `https://librivox.org/api/feed/audiobooks/?format=json&title=${encodeURIComponent(currentBookTitle)}&author=${encodeURIComponent(currentBookAuthor)}&limit=1&extended=1`;
      const response = await fetch(lvUrl);
      if (!response.ok) throw new Error(`LibriVox API error: ${response.status}`);
      const data = await response.json();
      if (data.books && data.books.length > 0 && data.books[0].sections && data.books[0].sections.length > 0) {
        audioPlayer.src = data.books[0].sections[0].url; 
        audioPlayer.classList.remove('hidden');
        audioPlayer.play();
      } else {
        alert('No matching audiobook found on LibriVox.');
      }
    } catch (err) {
      console.error('LibriVox error:', err);
      alert('Error fetching audiobook: ' + err.message);
    }
  });

  filterButton.addEventListener('click', filterBooks);
</script>
</body>
</html>
